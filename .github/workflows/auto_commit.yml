name: Auto Deploy TikTok Recorder

on:
  push:
    branches: [ main ]
  schedule:
    # Run auto-commit every 30 minutes
    - cron: '*/30 * * * *'
  workflow_dispatch:

jobs:
  auto-commit:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install psutil requests
    
    - name: Configure Git
      run: |
        git config --global user.name "TikTok Recorder Bot"
        git config --global user.email "recorder@github-actions.com"
        git config --global push.default simple
    
    - name: Run auto-commit
      run: |
        python auto_commit.py
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Verify deployment
      run: |
        echo "Deployment timestamp: $(date)"
        echo "Repository status:"
        git status --porcelain || true
        echo "Recent commits:"
        git log --oneline -5 || true

  health-monitor:
    runs-on: ubuntu-latest
    needs: auto-commit
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Check application health
      run: |
        # Try to check if the Render app is responsive
        echo "Checking application health..."
        
        # Add your Render app URL here when available
        # curl -f https://your-app-url.onrender.com/health || echo "Health check failed"
        
        echo "Health monitoring completed"
